---
attachments: [Clipboard_2023-05-05-18-18-10.png, Clipboard_2023-05-05-18-27-22.png, Clipboard_2023-05-05-18-46-20.png, Clipboard_2023-05-05-22-53-44.png]
title: Slope Trick
created: '2023-04-28T16:21:58.314Z'
modified: '2023-05-05T16:32:52.733Z'
---

# Slope Trick

## Resources
[Slope Trick Tutorial](https://codeforces.com/blog/entry/47821)
[Slope Trick explained](https://codeforces.com/blog/entry/77298)
[Desmos](https://www.desmos.com/calculator?lang=th)
[Pongsaphol's Video](https://www.youtube.com/watch?v=pQStFj-Ax3Q&t=808s&pp=ygULc2xvcGUgdHJpY2s%3D)

## Tutorial

ในการทำ Slope Trick จะใช้ Data Structure [$D$] ในการเก็บ`จุดเปลี่ยนความชัน`ของกราฟ โดยอาจใช้ `std::multiset` หรือ `std::vector` ในการเก็บได้
ค่าที่เก็บใน $D$ นั้นจะเป็น`จุดเปลี่ยนความชัน`ที่ทำให้ความชันเปลี่ยนไป $1$ เช่น 
ในการเก็บเส้นตรง $f_{1}(x) = |10 - x|$ นั้นจะเก็บจุดตัดเป็น $D = \{10, 10\}$ 
ถ้าเพิ่ม $f_{2}(x) = |8 - x|$ เข้าไปอีกเส้นจะทำให้ $D = \{8, 8, 10, 10\}$
ฟังก์ชันของสองเส้นนี้รวมกันก็จะเป็น $s(x) = f_{1}(x) + f_{2}(x) = |10 - x| + |8 - x|$

![](@attachment/Clipboard_2023-05-05-18-27-22.png)

สังเกตว่า $s(x)$ (เส้นสีม่วง) จะมีจุดเปลี่ยนความชันที่ $8$ และ $10$ และแต่ละครั้งที่เปลี่ยนคือ $+2$ ทำให้ต้องเก็บจุดนั้น ๆ $2$ ครั้ง
ในบางครั้ง $D$ ก็อาจจะใช้เก็บร่วมด้วย`จุดตัดแกน y`และ`ความชัน`ได้
ซึ่งในการรวมเส้น $2$ เส้นนั้น`จุดตัดแกน y`จะเป็น $cut_{1} + cut_{2}$ เมื่อ $cut_{i}$ เป็น`จุดตัดแกน y`ของเส้นหมายเลข $i$
ส่วนการรวม `ความชัน` ก็จะเป็น $m_{1} + m_{2}$ เมื่อ $m_{i}$ เป็น`ความชัน`ของเส้นหมายเลข $i$

## Properties
สมบัติของฟังก์ชันที่ทำ Slope Trick ได้
1. ฟังก์ชันนั้นเป็นฟังก์ชันต่อเนื่อง
2. ฟังก์ชันนั้นสามารถแบ่งออกเป็นฟังก์ชันย่อย แล้วแต่ละฟังก์ชันย่อยเป็นฟังก์ชันเส้นตรงที่มีความชันเป็นจำนวนเต็ม
3. ฟังก์ชันนั้นต้องเป็น Convex หรือ Concave

**Convex Function** เป็นฟังก์ชันที่เกิดจุดต่ำสุดได้
**Concave Function** เป็นฟังก์ชันที่เกิดจุดสูงสุดได้

ข้อสังเกต ฟังก์ชันที่ทำ Slope Trick ได้มักจะมี $f_{k}(\infty) = -f_{k}(-\infty)$

## Problems

### การหาค่ามัธยฐาน (Median)

**กำหนดให้** $y = |A_{1} - x| + |A_{2} - x| + |A_{3} - x| + ... + |A_{N} - x|$
หาค่าของ $y$ ที่น้อยที่สุดที่เป็นไปได้

**กำหนดให้** $f_{i}(x)$ หมายถึง $|A_{1} - x| + |A_{2} - x| + |A_{3} - x| + ... + |A_{i} - x|$ ที่มีค่าน้อยที่สุดเมื่อ $x \in \mathbb{Z}$
ดังนั้น $f_{i}(x) = |A_i - x| + f_{i - 1}(x)$ และสามารถเปลี่ยนเป็น $f_{i}(x) = l_{i} + f_{i - 1}(x)$ ได้เมื่อ $l_{i}(x) = |A_i - x|$

และเมื่อนิยาม $f_{N}(x)$ อย่างนี้แล้วจะทำให้ค่า $x$ ที่ดีที่สุดจะเกิดขึ้นเมื่อ $(x, f_{N}(x))$ เป็นจุดต่ำสุดของกราฟ $y = f_{N}(x)$

ในปัญหานี้สามารถ[พิสูจน์](https://math.stackexchange.com/questions/113270/the-median-minimizes-the-sum-of-absolute-deviations-the-ell-1-norm)ได้ว่า $x$ ที่ดีที่สุดคือค่า $med(A)$ ได้

**ตัวอย่าง**
$y = |10-x| + |8-x| + |9 - x|$

![](@attachment/Clipboard_2023-05-05-18-27-22.png)

สังเกตเส้น $l_{1}(x) = |10 - x|$ (สีดำ) และ $l_{2}(x) = |8 - x|$ (สีฟ้า)
ดังนั้น $f_{2}(x) จะได้เส้นสีม่วงพอดี

![](@attachment/Clipboard_2023-05-05-18-46-20.png)

และเมื่อรวมกับ $l_{3}(x) = 9$ (สีแดง) จะได้เป็นเส้นสีเขียวพอดี ซึ่งเส้นนี้มี $D = \{8,8,9,9,10,10\}$

ในการหาค่ามัธยฐานด้วยการทำpe Trick อย่างนี้จะใช้เวลา $O(\log(N))$ ต่อ $1$ เส้นที่ใส่ใน $D$ ทำให้ใช้เวลารวม $O(N\log(N))$

### NOI18_Safety

[Statement at oj.uz](https://oj.uz/problem/view/NOI18_safety)

มีตึกอยู่ $N$ ตึก โดยตึกหมายเลข $i$ มีความสูง $A_{i}$ เมตร
โดยตึกทั้งหมดนี่จะ**ปลอดภัย**ก็ต่อเมื่อ $|A_{k} - A_{k + 1}| \le h, \forall{k \in \{1, 2, ..., N-1\}}$
ในการทำให้ตึกทุกตึกปลอดภัยนั้นสามารถทำได้ $2$ operation คือ
1. ลดความสูงของตึกหมายเลข $k$ ลง $1$ เมตร
2. เพิ่มความสูงของตึกหมายเลข $k$ อีก $1$ เมตร

ต้องการหาจำนวน operation ที่น้อยที่สุดที่ทำให้ตึกทั้ง $N$ ตึกนี้ปลอดภัย

ก่อนที่จะไปพิจารณาปัญหาที่ $h \le 10^{9}$ เราจะพิจารณาปัญหาย่อยที่ $h = 0$ ก่อน

#### ปัญหาย่อย $h = 0$

**กำหนดให้** $f_{i}(x)$ หมายถึง จำนวน operation ที่น้อยที่สุดที่ทำให้ $A_{i} = x$ และ $A_{1} = A_{2} = A_{3} = ... = A_{i}$
จำนวน operation ในการทำให้ตึก $A_{i}$ มีความสูง $x$ คือ $|A_{i} - x|$
ดังนั้น $f_{i}(x) = |A_{i} - x| + f_{i - 1}(x)$

ในการ Implement Data Structure ที่ใช้ในการเก็บข้อมูลของ $f_{i}(x)$ ข้างต้นอาจใช้ `std::multiset` ในการเก็บได้โดยอาจใช้แนวคิดเดียวกับการหาค่ามัธยฐานได้

#### เมื่อ $h \le 10^9$

เราจะนิยาม $f_{i}(x)$ ใหม่เป็นจำนวน operation ที่น้อยที่สุดที่ทำให้ $A_{i} = x$ และ $|A_{j} - A{j + 1}| \le h$ โดยที่ $1 \le j < i$
ดังนั้นจะได้ว่าสมการของ $f_{i}(x) = |A_{i} - x| + \min\limits_{x-h \le k \le x+h}(f_{i - 1}(k))$
และ $g_{i}(x) = \min\limits_{x-h \le k \le x+h}(f_{i}(k))$ ทำให้ $f_{i}(x) = |A_{i} - x| + g_{i - 1}(x)$

$g_{i}(x)$ คือจำนวน operation ที่น้อยที่สุดที่ยังถูกเงื่อนไขเมื่อ $A_{i} = x$

![](@attachment/Clipboard_2023-05-05-22-53-44.png)

สังเกตว่าเส้นสีแดงคือ $f_{i}(x)$ และ $g_{i}(x)$ เนื่องจาก $g_{i}(x)$ คือจำนวน operation ที่น้อยที่สุดที่ยังถูกเงื่อนไขเมื่อ $A_{i} = x$ กล่าวคือเป็น $f_{i}(x)$ ทีขยายไปทางซ้าย $-h$ และทางขวา $+h$

จากนั้นก็รวมเส้นไปเรื่อย ๆ แต่เนื่องจากมีการขยายไปซ้ายขวาฝั่งละ $h$ ทำให้ใน multiset จะเกิดการบวกลบค่า $h$ ได้ จึงจำเป็นต้องใช้ `lazy set` ในการเก็บแทน
ในการสร้าง `lazy set` ก็คือ `std::multiset` ธรรมดาที่มี `integer` ไว้เก็บว่า `lazy` ไปเท่าไหร่ทำให้เมื่อนำค่าจาก `std::multiset` ออกมาใช้จะมีค่าที่ถูกต้อง

แต่ว่าในปัญหานี้นั้นไม่สามารถใช้ `std::multiset` เพียง $1$ ตัวได้เนื่องจากต้องการหาค่าที่อยู่ตรงกลางเนื่องจากกราฟเว้าลงมาจนตรงกลางของ Data Structure นั้นทำให้เกิดค่า $\min{f_{i}(x)}$
และเนื่องจากต้องการหาตรงกลางของ Data Structure และในการทำ lazy ค่า $h$ จึงใช้ `std::multiset` จำนวน $2$ ตัวเพื่อเก็บ`จุดเปลี่ยนความชัน`ฝั่งซ้ายและฝั่งขวา

ในการใส่เส้นใหม่แต่ละครั้งทำให้อาจค่าของ $y_{min}$ เปลี่ยนไปได้แต่จะไม่มีโอกาสที่ทำให้ $y_{min}$ ลดลงเนื่องจากเพิ่มเส้นใหม่ลงไปเรื่อย ๆ และจำนวน operation ที่ใช้ก็จะเพิ่มขึ้นหรือเท่าเดิมไม่มีทางลดลง



[Solution Code](https://oj.uz/submission/736054)
